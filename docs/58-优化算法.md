# 58 - ä¼˜åŒ–ç®—æ³•

---

### ğŸ¦ æœ¬èŠ‚è¯¾ç¨‹è§†é¢‘åœ°å€ ğŸ‘‡

[![Bilibil](https://i2.hdslb.com/bfs/archive/f163ed143e1cd21ab9bd24ad7121f01a05336a4f.jpg@640w_400h_100Q_1c.webp)](https://www.bilibili.com/video/BV1bP4y1p7Gq)

## ä¼˜åŒ–é—®é¢˜

å¯¹äºæ·±åº¦å­¦ä¹ é—®é¢˜ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå…ˆå®šä¹‰æŸå¤±å‡½æ•°ã€‚ä¸€æ—¦æˆ‘ä»¬æœ‰äº†æŸå¤±å‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä¼˜åŒ–ç®—æ³•æ¥å°è¯•**æœ€å°åŒ–æŸå¤±**ã€‚åœ¨ä¼˜åŒ–ä¸­ï¼ŒæŸå¤±å‡½æ•°é€šå¸¸è¢«ç§°ä¸ºä¼˜åŒ–é—®é¢˜çš„ç›®æ ‡å‡½æ•°ã€‚æŒ‰ç…§ä¼ ç»Ÿå’Œæƒ¯åˆ™ï¼Œå¤§å¤šæ•°ä¼˜åŒ–ç®—æ³•éƒ½å…³æ³¨çš„æ˜¯æœ€å°åŒ–ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦æœ€å¤§åŒ–ç›®æ ‡ï¼Œé‚£ä¹ˆæœ‰ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆï¼šåœ¨ç›®æ ‡å‡½æ•°å‰åŠ è´Ÿå·å³å¯ã€‚

- ä¸€èˆ¬å½¢å¼

  $$\text{minimize}\ f(\bf{x})\quad \text{subject to}\ \bf{x}\in C$$

  - ç›®æ ‡å‡½æ•°ï¼ˆåœ¨ Deep Learning ä¸­ä¸ºæŸå¤±å‡½æ•°ï¼‰ $f:\mathbb R^n\rightarrow\mathbb R$
  - é™åˆ¶é›†åˆä¾‹å­ï¼š

    $C=\{\bf{x}|\mathbb{h_1}(\bf {x})=0,...,\mathbb{h_m}(\bf{x})=0,\mathbb{g_1}(\bf {x})\le 0,...,\mathbb{g_r}(\bf {x})\}$

  - å¦‚æœ $C=\mathbb {R}^n$ ï¼Œé‚£å°±æ˜¯**ä¸å—é™**ï¼ˆDeep Learning é€šå¸¸é€‰ç”¨æ­¤æ¡ä»¶ï¼‰

### å±€éƒ¨æœ€å° vs å…¨å±€æœ€å°

- å…¨å±€æœ€å° ${\bf x^*}$: $f({\bf x^*})\le f({\bf x})\quad \forall {\bf x}\in C$
- å±€éƒ¨æœ€å° ${\bf x^*}$: å­˜åœ¨$\epsilon$ï¼Œä½¿å¾— $f({\bf x^*})\le f({\bf x})\quad \forall {\bf x}\in ||{\bf x^*}-{\bf x}||\le\epsilon$
- ä½¿ç”¨è¿­ä»£ä¼˜åŒ–ç®—æ³•æ¥æ±‚è§£ï¼Œ**ä¸€èˆ¬åªèƒ½ä¿è¯æ‰¾åˆ°å±€éƒ¨æœ€å°å€¼**

![local&global minimize](https://zh.d2l.ai/_images/output_optimization-intro_70d214_39_0.svg)

> ä¹Ÿå­˜åœ¨ç‰¹ä¾‹æƒ…å†µï¼Œå³åœ¨**å‡¸ä¼˜åŒ–**ï¼ˆConvex Optimizationï¼‰é—®é¢˜ä¸­ï¼Œå±€éƒ¨æœ€å°å’Œå…¨å±€æœ€å°æ˜¯ç­‰ä»·çš„ã€‚**å‡¸æ€§**ï¼ˆconvexityï¼‰åœ¨ä¼˜åŒ–ç®—æ³•çš„è®¾è®¡ä¸­èµ·åˆ°è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œ è¿™ä¸»è¦æ˜¯ç”±äºåœ¨è¿™ç§æƒ…å†µä¸‹å¯¹ç®—æ³•è¿›è¡Œåˆ†æå’Œæµ‹è¯•è¦å®¹æ˜“å¾—å¤šã€‚ æ¢è¨€ä¹‹ï¼Œå¦‚æœè¯¥ç®—æ³•ç”šè‡³åœ¨å‡¸æ€§æ¡ä»¶è®¾å®šä¸‹çš„æ•ˆæœå¾ˆå·®ï¼Œ é€šå¸¸æˆ‘ä»¬å¾ˆéš¾åœ¨å…¶ä»–æ¡ä»¶ä¸‹çœ‹åˆ°å¥½çš„ç»“æœã€‚ æ­¤å¤–ï¼Œå³ä½¿æ·±åº¦å­¦ä¹ ä¸­çš„ä¼˜åŒ–é—®é¢˜é€šå¸¸æ˜¯éå‡¸çš„ï¼Œ å®ƒä»¬ä¹Ÿç»å¸¸åœ¨å±€éƒ¨æå°å€¼é™„è¿‘è¡¨ç°å‡ºä¸€äº›å‡¸æ€§ã€‚æ¥ä¸‹æ¥ä»‹ç»ç›¸å…³çŸ¥è¯†ã€‚

## å‡¸ä¼˜åŒ–

### å‡¸é›†

å‡¸é›†ï¼ˆconvex setï¼‰æ˜¯å‡¸æ€§çš„åŸºç¡€ã€‚

- ä¸€ä¸ª $\mathbb {R}^n$ çš„å­é›† $C$ æ˜¯å‡¸å½“ä¸”ä»…å½“ï¼š

  $$
  \alpha\bf {x}+(\mathbb{1}-\alpha)\bf {y}\in C \qquad
  \forall \alpha \in [\mathbb{0,1}]\quad \forall \bf{x},\bf{y}\in C
  $$

> ç›´è§‚è¯´ï¼Œå¦‚æœä¸€ä¸ªåŒºåŸŸæ˜¯å‡¸é›†ï¼Œåˆ™åœ¨é›†åˆä¸­æ‰¾ä»»æ„ä¸¤ä¸ªç‚¹è¿æˆä¸€æ¡çº¿ï¼Œçº¿éƒ½åœ¨åŒºåŸŸå†…

![convex](https://zh.d2l.ai/_images/pacman.svg)

### å‡¸å‡½æ•°

æˆ‘ä»¬æœ‰äº†å‡¸é›†ï¼Œæˆ‘ä»¬å¯ä»¥å¼•å…¥å‡¸å‡½æ•°ï¼ˆconvex functionï¼‰

- å¯¹äºå‡½æ•°$f:\mathbf{C} \rightarrow \mathbb{R}$æ˜¯å‡¸ï¼Œå½“ä¸”ä»…å½“ï¼š
  $$
  f(\alpha{\bf x}+(1-\alpha){\bf y})\le\alpha f({\bf x})+(1-\alpha)f({\bf y})\quad \forall\alpha\in[0,1]\ \forall{\bf x}, {\bf y}\in C
  $$
- å¦‚æœ $\bf {x}\ne y,\alpha\in(\mathbb{0,1})$ æ—¶ä¸ç­‰å¼ä¸¥æ ¼æˆç«‹ï¼Œé‚£ä¹ˆå«ä¸¥æ ¼å‡¸å‡½æ•°

![](https://zh.d2l.ai/_images/output_convexity_94e148_18_0.svg)

### å‡¸å‡½æ•°ä¼˜åŒ–

- å¦‚æœä»£ä»·å‡½æ•° $f$ æ˜¯å‡¸çš„ï¼Œä¸”é™åˆ¶é›†åˆ $C$ æ˜¯å‡¸çš„ï¼Œé‚£ä¹ˆå°±æ˜¯å‡¸ä¼˜åŒ–é—®é¢˜ï¼Œé‚£ä¹ˆå±€éƒ¨æœ€å°ä¸€å®šæ˜¯å…¨å±€æœ€å°
- ä¸¥æ ¼å‡¸ä¼˜åŒ–é—®é¢˜æœ‰å”¯ä¸€çš„å…¨å±€æœ€å°

### å‡¸å’Œéå‡¸ä¾‹å­

- å‡¸

  - [çº¿æ€§å›å½’](08-çº¿æ€§å›å½’.md)ï¼š$f({\bf x})=||{\bf Wx}-{\bf b}||_2^2$
  - [Softmax å›å½’](09-Softmaxå›å½’.md)
    > ç»Ÿè®¡ä¸Šæ›´å…³å¿ƒå‡¸æ€§çš„

![convex](Images/058-04.jpg)

- éå‡¸
  - MLPã€CNNã€RNNã€Attention
    > éçº¿æ€§çš„ï¼Œéå‡¸çš„å‡½æ•°è¡¨è¾¾èƒ½åŠ›å¼ºï¼Œæ·±åº¦å­¦ä¹ æ›´å…³æ³¨éå‡¸

![](Images/non_convex_optimization.jpeg)

## æ¢¯åº¦ä¸‹é™

![GD](https://zh.d2l.ai/_images/output_gd_79c039_90_1.svg)

- æœ€ç®€å•çš„è¿­ä»£æ±‚è§£ç®—æ³•
- é€‰å–å¼€å§‹ç‚¹ ${\bf x_0}$
- å¯¹ $t=1,...,T$
  - ${\bf x_t}={\bf x_{t-1}}-\eta\nabla f({\bf x_{t-1}})$
- $\eta$ å«åšå­¦ä¹ ç‡

è‘—åçš„ 3Blue1Brown åšä¸»åšè¿‡ä¸€æœŸå…³äºæ¢¯åº¦ä¸‹é™çš„ç§‘æ™®è§†é¢‘ ğŸ‘‡ æ¨èè§‚çœ‹

[![Bilibil](https://i2.hdslb.com/bfs/archive/7db6e4ecbe249b369dca33211383303bef33f477.jpg@640w_400h_100Q_1c.webp)](https://www.bilibili.com/video/BV1Ux411j7ri)

### éšæœºæ¢¯åº¦ä¸‹é™ï¼ˆSGDï¼‰

![SGD](https://zh.d2l.ai/_images/output_sgd_baca77_18_1.svg)

- æœ‰ $n$ ä¸ªæ ·æœ¬æ—¶ï¼Œè®¡ç®— $f({\bf x})={1\over n}\sum_{i=0}^nl_i({\bf x})$ çš„å¯¼æ•°å¤ªè´µ
- éšæœºæ¢¯åº¦ä¸‹é™åœ¨æ—¶é—´ $t$ éšå³é€‰æ‹©æ ·æœ¬ $t_i$ æ¥è¿‘ä¼¼ $f(x)$

  $$
  {\bf x_t}={{\bf x_{t-1}}-\eta\nabla l_{t_i}({\bf x_{t-1}})}\\
  \mathbb E\left[\nabla l_{t_i}({\bf x_{t-1}})\right] \approx \mathbb E[\nabla f({\bf x})]
  $$

  > æ±‚å¯¼æ˜¯çº¿æ€§å¯åŠ çš„ï¼Œå› æ­¤å±€éƒ¨æœŸæœ›æ¥è¿‘äºæ•´ä½“

### å°æ‰¹é‡éšæœºæ¢¯åº¦ä¸‹é™ï¼ˆmini-batch SGDï¼‰

![compare](https://zh.d2l.ai/_images/output_minibatch-sgd_f4d60f_150_0.svg)

- è®¡ç®—å•æ ·æœ¬çš„æ¢¯åº¦éš¾å®Œå…¨åˆ©ç”¨ç¡¬ä»¶èµ„æºï¼Œæ— æ³•åˆ©ç”¨ç¡¬ä»¶çš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›
- å°æ‰¹é‡éšæœºæ¢¯åº¦ä¸‹é™åœ¨æ—¶é—´ $t$ é‡‡æ ·ä¸€ä¸ªéšæœºå­é›† $I_t\subset\{1,...,n\}$ ä½¿å¾— $|{\bf I_t}|=b$
  $$
  {\bf x_t}={\bf x_{t-1}}-{\eta\over b}\sum_{i\in{\bf I_t}}\nabla l_i({\bf x_{t-1}})
  $$
- åŒæ ·ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— åçš„è¿‘ä¼¼ï¼Œä½†é™ä½äº†æ–¹å·®
  $$
  \mathbb E[{1 \over b}\sum_{i\in{\bf I_t}}\nabla l_i({\bf x})]=\nabla f({\bf x})
  $$
  > æ–¹å·®é™ä½äº†ï¼Œå™ªéŸ³å°±å°äº†ï¼Œæ–¹å‘å˜å¾—æ›´åŠ å¹³æ»‘ã€‚
  > æ‰¹é‡å¤§ï¼Œè®¡ç®—æ…¢ï¼Œæ”¶æ•›å¿«ï¼›æ‰¹é‡å°ï¼Œè®¡ç®—å¿«ï¼Œæ”¶æ•›æ…¢ï¼Œæ‰€ä»¥è¦æƒè¡¡

### å†²é‡æ³•/åŠ¨é‡æ³•ï¼ˆMomentumï¼‰

![momentum](https://zh.d2l.ai/_images/output_momentum_e3683f_30_1.svg)

- å†²é‡æ³•ä½¿ç”¨å¹³æ»‘è¿‡çš„æ¢¯åº¦å¯¹æƒé‡æ›´æ–°

  $$
  {\bf g_t}={1 \over b}\sum_{i\in{\bf I_t}}\nabla l_i({\bf x_{t-1}})\\
  {\bf v_t}=\beta{\bf v_{t-1}}+{\bf g_t}\\
  {\bf w_t}={\bf w_{t-1}}-\eta{\bf v_t}
  $$

- å°†ç¬¬äºŒæ¡å…¬å¼å±•å¼€,å¯ä»¥èµ·åˆ°æ¢¯åº¦å¹³æ»‘ä½œç”¨ï¼š
  $$
  {\bf v_t}={\bf g_t}+\beta{\bf g_{t-1}}+\beta^2{\bf g_{t-2}}+\beta^3{\bf g_{t-3}}+...
  $$
  > $\beta$ å¸¸è§å–å€¼ $[0.5,0.9,0.95,0.99]$

ä¸åŒ$\beta$å–å€¼å¯¹ä¼˜åŒ–ç»“æœçš„å½±å“ï¼š

![increasing-momentum](Images/increasing-momentum.gif)

ä¸åŒ$\beta$å–å€¼çš„æœ‰æ•ˆæ ·æœ¬æƒé‡çš„å¯¹æ¯”å›¾ï¼Œå¯çŸ¥$\beta$è¶Šå¤§ï¼Œå†å²å€¼å¯¹å½“å‰å€¼å½±å“è¶Šå¤§ï¼š

![momentum_beta](https://zh.d2l.ai/_images/output_momentum_e3683f_54_0.svg)

> åœ¨å‡ ä¹æ‰€æœ‰æ·±åº¦å­¦ä¹ æ¡†æ¶éƒ½å®ç°äº†åŠ¨é‡æ³•ï¼Œå¯ä»¥é€šè¿‡åœ¨ä¼˜åŒ–ç®—æ³•å‡½æ•°ä½¿ç”¨`momentum`å‚æ•°è¿›è¡Œå¯ç”¨

è¿˜å¯ä»¥è§‚çœ‹å´æ©è¾¾ Deep Learning å…¬å¼€è¯¾çš„åŠ¨é‡æ³•ä¸€èŠ‚ ğŸ‘‡

[![Bilibil](https://i2.hdslb.com/bfs/archive/333ddb3535b03cdd9a02d154fd798f767151a431.jpg@640w_400h_100Q_1c.webp)](https://www.bilibili.com/video/BV1FT4y1E74V?p=66)

### Adam

> ä¼˜åŒ–æ•ˆæœéƒ½åœ¨ä¼¯ä»²ä¹‹é—´ï¼Œä¸ä¸€å®šæœ‰ SGD+Momentum ä»”ç»†è°ƒå‚åçš„æ•ˆæœå¥½ï¼ŒAdam æœ€å¤§çš„ä¼˜ç‚¹æ˜¯å¯¹å­¦ä¹ ç‡ä¸æ•æ„Ÿï¼Œéå¸¸éå¸¸å¹³æ»‘

![adam_vs_sgd_momeunt](Images/adam_vs_sgd_momeunt.gif)

Adam ç®—æ³•çš„å…³é”®ç»„æˆéƒ¨åˆ†ä¹‹ä¸€æ˜¯ï¼šå®ƒä½¿ç”¨æŒ‡æ•°åŠ æƒç§»åŠ¨å¹³å‡å€¼æ¥ä¼°ç®—æ¢¯åº¦çš„åŠ¨é‡å’Œç¬¬äºŒåŠ›çŸ©ï¼š

- è®°å½• ${\bf v_t}=\beta_1{\bf v_{t-1}}+(1-\beta_1){\bf g_t}$ï¼Œé€šå¸¸ $\beta_1=0.9$
  > ç›¸å½“äºè¿›ä¸€æ­¥æ”¾ç¼©äº†å½“å‰æ¢¯åº¦
  >
  > å±•å¼€ ${\bf v_t}=(1-\beta_1)({\bf g_t}+\beta_1{\bf g_{t-1}}+\beta_1^2{\bf g_{t-2}}+\beta_1^3{\bf g_{t-3}}+...)$
  >
  > å› ä¸º $\sum_{i=0}^\infty \beta_1^i={1 \over 1-\beta_1}$ï¼Œæ‰€ä»¥æƒé‡å’Œä¸º $1$
  >
  > ç”±äº ${\bf v_0}=0$ï¼Œä¸” $\sum_{i=0}^t \beta_1^i={1-\beta_1^t \over 1-\beta_1}$ï¼Œ
    ä¿®æ­£ ${\bf \hat v_t}={{\bf v_t}\over 1-\beta_1^t}$ï¼Œ
  > å½“$t$ ä¸æ˜¯æ— ç©·å¤§çš„æ—¶å€™ï¼Œå°±éœ€è¦æ­¤ä¿®æ­£
- ç±»ä¼¼è®°å½• ${\bf s_t}=\beta_2{\bf s_{t-1}}+(1-\beta_2){\bf g_t}^2$ï¼Œé€šå¸¸ $\beta_2=0.999$ï¼Œä¸”ä¿®æ­£ ${\bf \hat s_t}={{\bf s_t}\over 1-\beta_2^t}$
  > ç›¸å½“äºå¯¹æ¯ä¸ªå…ƒç´ çš„å¹³æ–¹åš smooth
- è®¡ç®—é‡æ–°è°ƒæ•´åçš„æ¢¯åº¦ ${\bf g_t'}={{\bf \hat v_t}\over\sqrt{\bf \hat s_t}+\epsilon}$
  > ä¸åŒç‰¹å¾çš„æ¢¯åº¦æœ‰å¤§æœ‰å°ï¼Œé€šè¿‡è¯¥æ“ä½œï¼Œå¯ä½¿æ¢¯åº¦æ§åˆ¶åœ¨ä¸€ä¸ªé€‚å½“çš„èŒƒå›´ï¼Œé˜²æ­¢è¿‡å¤§æˆ–è¿‡å°ï¼Œ
  > ç›¸å½“äºåšå½’ä¸€åŒ–ï¼Œç±»ä¼¼çš„æŠ€æœ¯è¿˜æœ‰ [Batch Normalization](26-æ‰¹é‡å½’ä¸€åŒ–.md)
- æœ€åæ›´æ–° ${\bf w_t}={\bf w_{t-1}}-\eta{\bf g_t'}$

#### âš  æ³¨æ„ï¼ï¼ï¼Adamä¸èƒ½ä¸Weight Decayæ··ç”¨

è®ºæ–‡[ã€ŠDecoupled Weight Decay Regularizationã€‹](https://arxiv.org/abs/1711.05101v3)æŒ‡å‡ºåœ¨Adamä¼˜åŒ–å™¨ä¸­ï¼Œweight decayä¸L2æ­£åˆ™å¹¶ä¸ç­‰ä»·ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­ç¡®å®å‘ç°Adam+Weight decayåè€Œä¼šé€ æˆç»“æœæ›´å·®çš„ç°è±¡ï¼Œå‚è€ƒğŸ‘‰[è¿™é‡Œ](extra/ç•ªå¤–04-Kaggleç«èµ›å®è·µç»éªŒ.md)ã€‚è¦å¯¹ä½¿ç”¨Adamä¼˜åŒ–ç®—æ³•çš„æ¨¡å‹å¢åŠ æ­£åˆ™ï¼Œå¯ä»¥æ¢ç”¨AdamWç®—æ³•ï¼Œå‚è€ƒğŸ‘‰[Pytorchæ–‡æ¡£](https://pytorch.org/docs/stable/generated/torch.optim.AdamW.html)

è¿˜å¯ä»¥è§‚çœ‹å´æ©è¾¾ Deep Learning å…¬å¼€è¯¾çš„Adamä¸€èŠ‚ ğŸ‘‡

[![Bilibil](https://i2.hdslb.com/bfs/archive/333ddb3535b03cdd9a02d154fd798f767151a431.jpg@640w_400h_100Q_1c.webp)](https://www.bilibili.com/video/BV1FT4y1E74V?p=68)

## æ€»ç»“

- æ·±åº¦å­¦ä¹ æ¨¡å‹å¤§å¤šæ˜¯éå‡¸
- å°æ‰¹é‡éšæœºæ¢¯åº¦ä¸‹é™æ˜¯æœ€å¸¸ç”¨çš„ä¼˜åŒ–ç®—æ³•
- å†²é‡å¯¹æ¢¯åº¦åšå¹³æ»‘
- Adam å¯¹æ¢¯åº¦åšå¹³æ»‘ï¼Œä¸”å¯¹æ¢¯åº¦å„ä¸ªç»´åº¦å€¼åšé‡æ–°è°ƒæ•´ï¼Œä¸”å¯¹å­¦ä¹ ç‡å–å€¼èŒƒå›´æ›´åŠ å®½æ¾

> ä¸åŒä¼˜åŒ–ç®—æ³•çš„å¯è§†åŒ–å¯¹æ¯”

![optimizar_compare](Images/optimizar_compare.gif)

![optimizar_compare](Images/058-09.gif)
