## ç¥ç»ç½‘ç»œçš„æ¢¯åº¦

### ğŸ¦ æœ¬èŠ‚è¯¾ç¨‹è§†é¢‘åœ°å€ ğŸ‘‰[Bilibil](https://www.bilibili.com/video/BV1u64y1i75a?spm_id_from=333.999.0.0)

è€ƒè™‘ä¸€ä¸ªæœ‰då±‚çš„ç¥ç»ç½‘ç»œã€‚

$${\bf h^t}=f_t({\bf h^{t-1}})\quad and\quad y=l\circ f_d\circ...\circ f_1({\bf x})$$

è®¡ç®—æŸå¤± $l$ å…³äºå‚æ•° ${\bf W_t}$ çš„æ¢¯åº¦

$${\partial l\over\partial{\bf W_t}}={\partial l\over\partial{\bf h^d}}{\partial {\bf h^d}\over\partial{\bf h^{d-1}}}...{\partial {\bf h^{t+1}}\over\partial{\bf h^t}}{\partial {\bf h^t}\over\partial{\bf W^t}}$$

ä¸­é—´ç›¸å½“äº$d-t$æ¬¡çŸ©é˜µä¹˜æ³•ã€‚

æ•°å€¼ç¨³å®šçš„å¸¸è§ä¸¤ä¸ªé—®é¢˜ï¼š

- **æ¢¯åº¦çˆ†ç‚¸**

$$1.5^{100}\approx4\times10^{17}$$

- **æ¢¯åº¦æ¶ˆå¤±**

$$0.8^{100}\approx2\times10^{-10}$$

**ä¾‹å­ï¼šMLP**

åŠ å…¥å¦‚ä¸‹MLPï¼ˆä¸ºäº†ç®€å•çœç•¥äº†åç§»ï¼‰

$$f_t({\bf h^{t-1}})=\sigma(\bf W^th^{t-1})$$
$${\partial{\bf h_t}\over\partial{\bf h^{t-1}}}=diag(\sigma\prime(\bf W^th^{t-1}))(\bf W^t)^T$$

$$\prod_{i=t}^{d-1}{\partial{\bf h^{i+1}}\over\partial\bf h^i}=\prod_{i=t}^{d-1}diag(\sigma\prime({\bf W^ih^{i-1})})(\bf W^i)^T$$

$\sigma()$æ¿€æ´»å‡½æ•°å¯¹æ¯ä¸ªå…ƒç´ åšè¿ç®—ï¼Œè¾“å…¥ä¸€ä¸ªä¸ªå‘é‡ï¼Œæ±‚å¯¼æ‰“åŒ…ä¸ºå¯¹è§’çŸ©é˜µã€‚

å¦‚æœ$d-t$å¾ˆå¤§ï¼Œå€¼å°†ä¼šå¾ˆå¤§

**æ¢¯åº¦çˆ†ç‚¸**

ä½¿ç”¨ReLUä½œä¸ºæ¿€æ´»å‡½æ•°ï¼š

$$\sigma(x)=\max(0,x)\quad and\qquad \sigma\prime(x)={\begin{cases}1&if\ x\lt0\\0&otherwise\end{cases}}$$

$$\prod_{i=t}^{d-1}{\partial{\bf h^{i+1}}\over\partial{\bf h^i}}=\prod_{i=t}^{d-1}diag(\sigma\prime({\bf W^ih^{i-1}}))(\bf W^i)^T$$

å…¶ä¸­ä¸€äº›å…ƒç´ æ¥è‡ªäº${\prod_{i=t}^{d-1}\bf (W^i)^T}$ï¼Œå¦‚æœ$\bf W$æœ‰å¾ˆå¤§çš„å…ƒç´ ï¼Œé‚£ä¹ˆæˆç»©å°±ä¼šå¾ˆå¤§ã€‚

**æ¢¯åº¦çˆ†ç‚¸çš„é—®é¢˜**

- å€¼è¶…å‡ºå€¼åŸŸ(infinity)ï¼Œå¯¹äº16ä½æµ®ç‚¹æ•°å°¤ä¸ºä¸¥é‡ï¼ˆæ•°å€¼åŒºé—´6e-5 - 6e4ï¼‰
- å¯¹å­¦ä¹ ç‡æ•æ„Ÿ
  - å¦‚æœå­¦ä¹ ç‡å¤ªå¤§-å¤§å‚æ•°å€¼-æ›´å¤§çš„æ¢¯åº¦
  - å¦‚æœå­¦ä¹ ç‡å¤ªå°-è®­ç»ƒæ— è¿›å±•
  - æˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¸æ–­è°ƒæ•´å­¦ä¹ ç‡

**æ¢¯åº¦æ¶ˆå¤±**

ä½¿ç”¨sigmoidä½œä¸ºæ¿€æ´»å‡½æ•°ã€‚

![](\Images/sigmoid.png)

åæ ‡è½´è¿œæ–¹æ¢¯åº¦æ¥è¿‘äº0ã€‚

**æ¢¯åº¦æ¶ˆå¤±çš„é—®é¢˜**

- æ¢¯åº¦å€¼å˜ä¸º0
  - å¯¹16ä½æµ®ç‚¹æ•°å°¤ä¸ºä¸¥é‡
- è®­ç»ƒæ²¡æœ‰è¿›å±•
  - ä¸ç®¡å¦‚ä½•é€‰æ‹©å­¦ä¹ ç‡
- å¯¹äºåº•éƒ¨å±‚å°¤ä¸ºä¸¥é‡
  - ä»…ä»…é¡¶éƒ¨å±‚è®­ç»ƒçš„è¾ƒå¥½ï¼ˆåå‘è®¡ç®—ï¼‰
  - æ— æ³•è®©ç¥ç»ç½‘ç»œæ›´æ·±

**æ€»ç»“**

å½“æ•°å€¼è¿‡å¤§æˆ–è¿‡å°ä¼šå¯¼è‡´æ•°å€¼é—®é¢˜ï¼›

å¸¸å‘ç”Ÿåœ¨æ·±åº¦æ¨¡å‹ä¸­ï¼Œå› ä¸ºä¼šå¯¹ $n$ ä¸ªæ•°ç´¯ä¹˜ã€‚

### è®©è®­ç»ƒæ›´åŠ ç¨³å®š

ç›®æ ‡ï¼šè®©æ¢¯åº¦å€¼åœ¨åˆç†çš„èŒƒå›´å†…ï¼Œä¾‹å¦‚$[1e-6,1e3]$ï¼›

- å°†ä¹˜æ³•å˜åŠ æ³•ï¼šResNet, LSTMï¼›

- å½’ä¸€åŒ–ï¼šæ¢¯åº¦å½’ä¸€åŒ–ï¼ˆæŠŠæ¢¯åº¦normalizeï¼‰ï¼Œæ¢¯åº¦å‰ªè£ï¼ˆclippingï¼‰ï¼›

- åˆç†çš„æƒé‡åˆå§‹å’Œæ¿€æ´»å‡½æ•°ã€‚

**è®©æ¯å±‚çš„æ–¹å·®æ˜¯ä¸€ä¸ªå¸¸æ•°**

å°†æ¯å±‚çš„è¾“å‡ºå’Œæ¢¯åº¦éƒ½çœ‹åšéšæœºå˜é‡ï¼Œè®©æ¯ä¸€å±‚çš„**å‡å€¼å’Œæ–¹å·®éƒ½ä¿æŒä¸€è‡´**ã€‚



$$
æ­£å‘ï¼š\begin{array}{l}
    {\mathbb E[h_i^t]=0}\\
    {Var[h_i^t]=a} 
\end{array}
$$

$$
åå‘ï¼š\mathbb E\left[{\partial l\over \partial h_i^t}\right]=0\quad
Var\left[{\partial l\over \partial h_i^t}\right]=b \quad \forall i,t
$$

å³æŸå¤±å‡½æ•°å¯¹æ¯å±‚çš„æ¯ä¸ªå…ƒç´ çš„æ¢¯åº¦çš„æœŸæœ›å’Œåå·®ä¹Ÿæœä»æ’å®šã€‚

**æƒé‡åˆå§‹åŒ–**

- åœ¨åˆç†å€¼åŒºé—´é‡Œéšå³åˆå§‹å‚æ•°ï¼› 
- åœ¨è®­ç»ƒå¼€å§‹çš„æ—¶å€™æ›´å®¹æ˜“æœ‰æ•°å€¼ä¸ç¨³å®šï¼ˆæ¢¯åº¦å¤§ï¼‰ï¼› 
  - è¿œç¦»æœ€ä¼˜è§£çš„åœ°æ–¹æŸå¤±å‡½æ•°è¡¨é¢é‚£å¯èƒ½å¾ˆå¤æ‚ï¼›
  - æœ€ä¼˜è§£é™„è¿‘è¡¨é¢ä¼šæ¯”è¾ƒå¹³ï¼›
- ä½¿ç”¨$\aleph(0, 0.01)$æ¥åˆå§‹å¯èƒ½å¯¹å°ç½‘ç»œæ²¡é—®é¢˜ï¼Œä½†ä¸èƒ½ä¿è¯æ·±åº¦ç¥ç»ç½‘ç»œã€‚

ä»¥MLPä¸ºä¾‹ï¼Œå‡è®¾ $w^t_{i,j}$æ˜¯éµä»ç‹¬ç«‹åŒåˆ†å¸ƒçš„ï¼Œé‚£ä¹ˆ$\mathbb E[w^t_{i,j}]=0,\ Var[w^t_{i,j}]=\gamma_t$ï¼Œ$h^{t-1}_i$ç‹¬ç«‹äº${w_{i,j}^t}$

å‡è®¾æ²¡æœ‰æ¿€æ´»å‡½æ•°$\bf h^t=W^th^{t-1}$ï¼Œè¿™é‡Œ${\bf W^t}\in\mathbb R^{n_t\times n_{t-1}}$

$$\mathbb E[h_i^t]=\mathbb E\left[\sum_jw_{i,j}^th_j^{t-1}\right]=\sum_j\mathbb E[w_{i,j}]\mathbb E[h_j^{t-1}]=0$$

$$\begin{split}
Var[h_i^t]&=\mathbb E[(h_i^t)^2]-\sout{\mathbb E[(h_i^t)]^2}\\&=\mathbb E\left[\left(\sum_jw_i^th_j^{t-1}\right)^2\right]\\&=\mathbb E\left[\sum_j\left(w_{i,j}^t\right)^2\left(h_j^{t-1}\right)^2+\sout{\sum_{j\ne k}w_{i,j}^tw_{i,k}^th_j^{t-1}h_k^{t-1}}\right]\\&=\sum_jVar[w_{i,j}^t]Var[h_j^{t-1}]\\&=n_{t-1}\gamma_tVar[h_j^{t-1}]\end{split}$$

if input variance equals output variance:

$$n_{t-1}\gamma_t=1$$

**åå‘å‡å€¼ä¸æ–¹å·®**

è·Ÿæ­£å‘æƒ…å†µç±»ä¼¼

$${\partial l\over\partial{\bf h^{t-1}}}={\partial l\over\partial({{\bf h^t}}/{\bf W^t}})={\partial l\over\partial{\bf h^t}}{\bf W^t}\ \rightarrow\left({\partial l\over\partial{\bf h^{t-1}}}\right)^T=({\bf W^t})^T\left({\partial l\over\partial{\bf h^t}}\right)^T$$

å¯ä»¥ç†è§£ä¸ºå¯¹å•å±‚æ¯ä¸€ä¸ªè¾“å‡º${h_i^t}$çš„æœŸæœ›éƒ½æ’å®š

$$\begin{split}
\mathbb E\left[{\partial l\over\partial{h_i^{t-1}}}\right]&=\mathbb E\left[\left({\partial l\over\partial{h_i^t}}\right)\left({\partial {h_i^t}\over\partial{h_i^{t-1}}}\right)\right]\\
&=\mathbb E\left[\left({\partial l\over\partial{h_i^t}}\right)\left({\partial {\sum_jw_{i,j}h_j^{t-1}}\over\partial{h_i^{t-1}}}\right)\right]=0
\end{split}$$

$$\begin{split}
Var\left[{\partial l\over\partial{h_i^{t-1}}}\right]&=Var\left[\left({\partial l\over\partial{h_i^t}}\right)\left({\partial {h_i^t}\over\partial{h_i^{t-1}}}\right)\right]\\
&=Var\left[\left({\partial l\over\partial{h_i^t}}\right)\left({\partial {\sum_jw_{i,j}h_j^{t-1}}\over\partial{h_i^{t-1}}}\right)\right]\\
&=n_t\gamma_tVar\left[{\partial l\over\partial{h_i^t}}\right]\ \rightarrow n_t\gamma_t=1
\end{split}$$

**Xavieråˆå§‹**

åˆå§‹åŒ–æƒé‡æ—¶è®¾ç½®çš„æ–¹å·®æ˜¯æ ¹æ®è¾“å…¥è¾“å‡ºç»´åº¦æ¥ç¡®å®šçš„ã€‚

- éš¾ä»¥éœ€è¦æ»¡è¶³$n_{t-1}\gamma_t=1$å’Œ$n_t\gamma_t=1$ã€‚å› ä¸º$n_{t-1}$å’Œ$n_t$çš„å€¼æ˜¯ä¸å¯æ§åˆ¶çš„ã€‚
- Xavierä½¿å¾—${(n_{t-1}+n_t)\gamma_t\over2}=1\ \rightarrow\ \gamma_t={2\over(n_{t-1}+n_t)}$
  - æ­£æ€åˆ†å¸ƒ$\aleph(0,\sqrt{2/(n_{t-1}+n_t)})$
  - å‡åŒ€åˆ†å¸ƒ$\Re(-\sqrt{6/(n_{t-1}+n_t)}),\sqrt{6/(n_{t-1}+n_t)}))$ 
  
     -åˆ†å¸ƒ$\Re[-a,a]$å’Œæ–¹å·®æ˜¯$a^2/3$    
- é€‚é…æƒé‡å½¢çŠ¶å˜æ¢ï¼Œç‰¹åˆ«æ˜¯$n_t$ã€‚

**å‡å¦‚çº¿æ€§çš„æ¿€æ´»å‡½æ•°**

å‡è®¾$\sigma(x)=\alpha x+\beta$ï¼Œè¦ä½¿æ¿€æ´»å‡½æ•°å‰åçš„å‡å€¼(0)ã€æ–¹å·®ä¸å˜(1)ã€‚

&emsp;${\bf h'}={\bf W^th^{t-1}}$ and ${\bf h^t}=\sigma({\bf h'})$ 

&emsp;$$\mathbb E[h_i^t]=\mathbb E[\alpha h_i'+\beta]=\beta\ \rightarrow\ \beta=0$$

&emsp;$$\begin{split} Var[h_i^t]&=\mathbb E[(h_i^t)^2]-\mathbb E[(h_i^t)]^2\\&=\mathbb E[(\alpha h_i'+\beta)^2]-\beta^2\\&=\mathbb E[(\alpha^2 (h_i')^2+2\alpha\beta h_i'+\beta^2)]-\beta^2\\&=\alpha^2Var[h_i']\end{split} \ \rightarrow\ \alpha=1$$

**åå‘**

å‡è®¾$\sigma(x)=\alpha x+\beta$

$${\partial l\over\partial\bf h'}={\partial l\over\partial\bf h^t}{(\bf W^t)}^T\quad and\quad {\partial l\over\partial\bf h^{t-1}}=\alpha{\partial l\over\partial\bf h'}$$

$$
\begin{split}
\mathbb E\left[\partial l\over\partial h_i^{t-1}\right]&=\mathbb E\left[\left(\partial l\over\partial h_i^t\right)\left(\partial h_i^t\over\partial h_i^{t-1}\right)\right]\\
&=\mathbb E\left[\left(\partial l\over\partial \sigma(h_i')\right)\left(\partial \sigma(h_i')\over\partial h_i^{t-1}\right)\right]\\
&=0\ \rightarrow\ \beta=0
\end{split}
$$

åªæœ‰$\beta=0$ï¼Œæ‰å¯ä»¥çº¿æ€§æ±‚å¯¼ï¼Œä½¿:

$${\partial l\over\partial\bf h^{t-1}}=\alpha{\partial l\over\partial\bf h'}$$

æ’å®šæˆç«‹ã€‚

$$\begin{split}
Var\left[\partial l\over\partial h_i^{t-1}\right]&=Var\left[\alpha\left(\partial l\over\partial h_i'\right)\right]\\
&=\mathbb E\left[\alpha^2\left(\partial l\over\partial h_i'\right)^2\right]-\mathbb E\left[\alpha\left(\partial l\over\partial h_i'\right)\right]^2\\
&=\alpha^2Var\left[\partial l\over\partial h_i'\right]\rightarrow\ \alpha=1
\end{split}$$

**æ£€æŸ¥å¸¸ç”¨æ¿€æ´»å‡½æ•°**

ä½¿ç”¨æ³°å‹’å±•å¼€ï¼š
$$\sigma(x)={1\over2}+{x\over4}-{x^3\over48}+O(x^5)$$

$$tanh(x)=0+x-{x^3\over3}+O(x^5)$$

$$relu(x)=0+x\quad x\ge0$$

![](\Images/3-Figure1-1.png)

$tanh(x),relu(x)$åœ¨é›¶ç‚¹é™„è¿‘ï¼Œå­˜åœ¨åŒºé—´$f(x)=x$ï¼Œè€Œ$sigmoid(x)$åˆ™æ²¡æœ‰ï¼Œæ‰€ä»¥å¯ä»¥è°ƒæ•´ã€‚ä½†æ˜¯è¶…å‡ºäº†è¿™ä¸ªåŒºé—´ï¼Œä¼šä½¿å…¶å‡å€¼ã€æ–¹å·®å‘ç”Ÿå˜åŒ–ã€‚

è°ƒæ•´sigmoid:

$$4\times\sigma(x)-2$$

