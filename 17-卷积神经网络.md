# 17 - å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰

---

### ğŸ¦ æœ¬èŠ‚è¯¾ç¨‹è§†é¢‘åœ°å€ ğŸ‘‡

[![Bilibil](https://i1.hdslb.com/bfs/archive/7f53ce06c826938d646dfc7dbf010a741fa8c3cc.jpg@640w_400h_100Q_1c.webp)](https://www.bilibili.com/video/BV1L64y1m7Nh)

## ä¸ºä»€ä¹ˆéœ€è¦å·ç§¯

ä¸¾ä¸ª ğŸŒ°ï¼Œå¯¹äºç›®å‰ä¸»æµæ‰‹æœºæ‘„åƒå¤´æ¥è¯´ï¼Œè‡³å°‘æ‹¥æœ‰ 1200 ä¸‡åƒç´ æ‘„åƒå¤´ï¼Œä»¥æ­¤åƒç´ ä¸ºä¾‹ï¼Œæ‹æ‘„ä¸€å¼ ç…§ç‰‡ï¼Œå¤§æ¦‚èƒ½äº§ç”Ÿ 36M åƒç´ çš„å›¾ç‰‡ï¼ˆRGB ä¸‰ä¸ªé€šé“ï¼Œ$3\times12M$ï¼‰ï¼Œè‹¥ä½¿ç”¨ä¹‹å‰ç« èŠ‚ä»‹ç»çš„æ‹¥æœ‰ 100 ä¸ªç¥ç»å…ƒçš„å•éšè—å±‚ MLPï¼Œè¾“å…¥ 36M ç‰¹å¾ï¼Œ100 ä¸ªç¥ç»å…ƒå°±æœ‰ $36M\times100=3.6B=14GB$ å‚æ•°ï¼Œæ‰€ä»¥ä¸é€‚ç”¨ã€‚

æˆ‘ä»¬ä»…ä»…é€šè¿‡å°†å›¾åƒæ•°æ®å±•å¹³æˆä¸€ç»´å‘é‡è€Œå¿½ç•¥äº†æ¯ä¸ªå›¾åƒçš„ç©ºé—´ç»“æ„ä¿¡æ¯ï¼Œå†å°†æ•°æ®é€å…¥ä¸€ä¸ªå…¨è¿æ¥çš„å¤šå±‚æ„ŸçŸ¥æœºä¸­ã€‚ å› ä¸ºè¿™äº›ç½‘ç»œç‰¹å¾å…ƒç´ çš„é¡ºåºæ˜¯ä¸å˜çš„ï¼Œå› æ­¤æœ€ä¼˜çš„ç»“æœæ˜¯**åˆ©ç”¨å…ˆéªŒçŸ¥è¯†**ï¼Œå³**åˆ©ç”¨ç›¸è¿‘åƒç´ ä¹‹é—´çš„ç›¸äº’å…³è”æ€§**ï¼Œä»å›¾åƒæ•°æ®ä¸­å­¦ä¹ å¾—åˆ°æœ‰æ•ˆçš„æ¨¡å‹ã€‚

![Waldo](https://zh.d2l.ai/_images/where-wally-walker-books.jpg)

ä¸Šå›¾ä¸ºæ¸¸æˆâ€œWaldo åœ¨å“ªé‡Œâ€çš„ç¤ºä¾‹å›¾ï¼Œè¦æ±‚åœ¨ä¸€å¹…å›¾ç‰‡ä¸­æ‰¾ç‰¹å®šçš„å¯¹è±¡ã€‚å¯ä»¥å¼•ç”³å‡ºä¸¤ç‚¹ï¼š

- å¹³ç§»ä¸å˜æ€§ï¼ˆtranslation invarianceï¼‰ï¼šåˆ†ç±»å™¨ä¸å› å‡ºç°ä½ç½®æ”¹å˜è€Œæ”¹å˜è¯†åˆ«æ ‡å‡†ã€‚
- å±€éƒ¨æ€§ï¼ˆlocalityï¼‰ï¼šåªéœ€è¦åœ¨å±€éƒ¨å¯»æ‰¾å¯¹è±¡ï¼Œè€Œéè¦è¿œå¤„æ— å…³åŒºåŸŸã€‚

å·ç§¯ç¥ç»ç½‘ç»œï¼ˆconvolutional neural networkï¼ŒCNNï¼‰æ˜¯ä¸€ç±»å¼ºå¤§çš„ã€ä¸ºå¤„ç†å›¾åƒæ•°æ®è€Œè®¾è®¡çš„ç¥ç»ç½‘ç»œã€‚ å·ç§¯ç¥ç»ç½‘ç»œéœ€è¦çš„å‚æ•°å°‘äºå…¨è¿æ¥æ¶æ„çš„ç½‘ç»œï¼Œè€Œä¸”å·ç§¯ä¹Ÿå¾ˆå®¹æ˜“ç”¨ GPU å¹¶è¡Œè®¡ç®—ã€‚ å› æ­¤å·ç§¯ç¥ç»ç½‘ç»œé™¤äº†èƒ½å¤Ÿé«˜æ•ˆåœ°é‡‡æ ·ä»è€Œè·å¾—ç²¾ç¡®çš„æ¨¡å‹ï¼Œè¿˜èƒ½å¤Ÿé«˜æ•ˆåœ°è®¡ç®—ã€‚

## ä»å…¨è¿æ¥å±‚åˆ°å·ç§¯

- å°†è¾“å…¥å’Œè¾“å‡ºä»å‘é‡å˜ä¸º**çŸ©é˜µ**ï¼ˆå®½ Ã— é«˜ï¼‰
- å°†æƒé‡ä»åŸæ¥çš„äºŒç»´çŸ©é˜µå˜ä¸ºä¸º **4-D å¼ é‡**$(h, w)$åˆ°$(h', w')$

$$
\begin{aligned}
    [\mathbf{H}]_{i,j}&=\sum_{k} \sum_{l} [\mathbf{W}]_{i,j,k,l}[\mathbf{X}]_{k,l}+ [\mathbf{U}]_{i,j} \\
    &=\sum_{a}\sum_{b}[\mathbf{V}]_{i,j,a,b}[\mathbf{X}]_{i+a,j+b}+[\mathbf{U}]_{i,j}
\end{aligned}
$$

> $[\mathbf{H}]_{i,j}$ä¸ºéšè—è¡¨ç¤ºä¸­ä½ç½®$(i,j)$å¤„çš„åƒç´ ï¼›$[\mathbf{X}]_{k,l}$ä¸ºè¾“å…¥å›¾åƒä½ç½®$(i,j)$å¤„çš„åƒç´ ï¼›$[\mathbf{U}]_{i,j}$ä¸ºåç½®å‚æ•°
>
> $[\mathbf{W}]_{i,j,k,l}$ä¸ºæƒé‡çš„ 4D å¼ é‡ï¼Œå› ä¸ºåœ¨è¿™ä¸¤ä¸ªå››é˜¶å¼ é‡çš„å…ƒç´ ä¹‹é—´å­˜åœ¨ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚ æˆ‘ä»¬åªéœ€é‡æ–°ç´¢å¼•ä¸‹æ ‡ä½¿ $k=i+a,\ l=j+b$ï¼Œç”±æ­¤å¯å¾—$[\mathbf{V}]_{i,j,a,b}=[\mathbf{W}]_{i,j,ki+a,j+b}$ï¼Œç´¢å¼•$a$å’Œ$b$é€šè¿‡åœ¨æ­£åç§»å’Œè´Ÿåç§»ä¹‹é—´ç§»åŠ¨è¦†ç›–äº†æ•´ä¸ªå›¾åƒã€‚

> ä¸Šå¼ä»£è¡¨å¯¹äºéšè—è¡¨ç¤ºä¸­ä»»æ„ç»™å®šä½ç½®$(i,j)$å¤„çš„åƒç´ å€¼$h_{i,j}$ï¼Œå¯ä»¥é€šè¿‡åœ¨$x$ä¸­ä»¥$(i,j)$ä¸ºä¸­å¿ƒå¯¹åƒç´ è¿›è¡ŒåŠ æƒæ±‚å’Œå¾—åˆ°ï¼ŒåŠ æƒä½¿ç”¨çš„æƒé‡ä¸º$[\mathbf{V}]_{i,j,a,b}$

> æ­¤å¤„åšæŒ‰å…ƒç´ ç›¸ä¹˜çš„[å“ˆé©¬è¾¾ç§¯](05-çº¿æ€§ä»£æ•°.md)ã€‚

### å¹³ç§»ä¸å˜æ€§

ç°åœ¨å¼•ç”¨ä¸Šè¿°çš„ç¬¬ä¸€ä¸ªåŸåˆ™ï¼šå¹³ç§»ä¸å˜æ€§ã€‚æŒ‰ä¸Šæ–‡æ¨å¯¼ç»“æœï¼Œå¯ä»¥å¾—å‡ºï¼š

- $\mathbf{X}$çš„ç©ºé—´å¹³ç§»ï¼ˆ$iã€j$çš„å˜åŒ–ï¼‰åº”è¯¥ä»…å¯¼è‡´éšè—è¡¨ç¤º$\mathbf{H}$çš„å¹³ç§»ï¼Œä¹Ÿå°±æ˜¯è¯´$\mathbf{V}$å’Œ$\mathbf{U}$å®é™…ä¸Šä¸ä¾èµ–$(i,j)$çš„å€¼ï¼Œå³$[\mathbf{V}]_{i,j,a,b}=[\mathbf{V}]_{a,b}$ï¼Œä¸”$\mathbf{U}$æ˜¯å¸¸æ•°ï¼Œå®šä¸º$u$ï¼Œå› æ­¤ä¸Šå¼å¯ç®€åŒ–ä¸ºï¼š

$$
[\mathbf{H}]_{i,j}=\sum_{a} \sum_{b}[\mathbf{V}]_{a,b}[\mathbf{X}]_{i+a,j+b}+u
$$

ä»¥ä¸Šæ“ä½œï¼Œæœ¬è´¨ä¸Šæ˜¯ 2 ç»´~~å·ç§¯~~ **äº’ç›¸å…³ï¼ˆcross-correlationï¼‰**ï¼ˆä»å‰ç¥ç»ç½‘ç»œç ”ç©¶è€…å°†å·ç§¯å’Œäº’ç›¸å…³çš„æ¦‚å¿µææ··äº†ï¼Œå¦‚ä»Šå°†é”™å°±é”™äº†ï¼‰æˆ‘ä»¬æ˜¯åœ¨ä½¿ç”¨ç³»æ•° $[\mathbf{V}]_{a,b}$ å¯¹ä½ç½®$(i,j)$ é™„è¿‘çš„åƒç´  $(i+a,j+b)$ è¿›è¡ŒåŠ æƒå¾—åˆ° $[\mathbf{H}]i,j$ ã€‚ æ³¨æ„ï¼Œ $[\mathbf{V}]_{a,b}$çš„ç³»æ•°æ¯”$[\mathbf{V}]_{i,j,a,b}$å°‘å¾ˆå¤šï¼Œå› ä¸ºå‰è€…ä¸å†ä¾èµ–äºå›¾åƒä¸­çš„ä½ç½®ã€‚è¿™å°±æ˜¯æ˜¾è‘—çš„è¿›æ­¥ï¼ã€‚

### å±€éƒ¨æ€§

ç°å¼•ç”¨ç¬¬äºŒåŸåˆ™ï¼šå±€éƒ¨æ€§æŒ‡ï¼Œå½“è¯„ä¼°$[\mathbf{H}]_{i,j}$æ—¶ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ç”¨è¿œç¦»$x_{i,j}$çš„å‚æ•°ï¼Œå³åªéœ€è¦èšç„¦äº$x_{i,j}$é™„è¿‘åƒç´ å³å¯ã€‚

è§£å†³æ–¹æ¡ˆï¼šå½“$|a|,|b|\gt\Delta$æ—¶ï¼Œä½¿å¾—$v_{a,b}=0$ï¼Œä¹Ÿå°±æ˜¯è¯´æƒé‡åªé›†ä¸­äºä¸€ä¸ªå°èŒƒå›´è€Œä¸æ˜¯å…¨å±€ã€‚

$$
[\mathbf{H}]_{i,j}=\sum_{a=-\Delta}^\Delta\sum_{b=-\Delta}^\Delta [\mathbf{V}]_{a,b}[\mathbf{X}]_{i+a,j+b}+u
$$

ä¸Šå¼çš„è®¡ç®—ï¼Œä»£è¡¨æ˜¯ä¸€ä¸ªå·ç§¯å±‚ï¼ˆconvolutional layerï¼‰ï¼Œè€Œå·ç§¯ç¥ç»ç½‘ç»œæ˜¯åŒ…å«å·ç§¯å±‚çš„ä¸€ç±»ç‰¹æ®Šçš„ç¥ç»ç½‘ç»œã€‚

## æ•°å­¦ä¸Šçš„å·ç§¯[[1]](https://wiwiki.kfd.me/wiki/%E5%8D%B7%E7%A7%AF)è¿ç®—

åœ¨è¿›ä¸€æ­¥è®¨è®ºä¹‹å‰ï¼Œå…ˆç®€è¦å›é¡¾ä¸€ä¸‹ä¸ºä»€ä¹ˆä¸Šé¢çš„æ“ä½œè¢«ç§°ä¸ºâ€œå·ç§¯â€ã€‚åœ¨æ•°å­¦å’Œä¿¡å·å¤„ç†é¢†åŸŸä¸­ï¼Œä¸¤ä¸ªå‡½æ•°ï¼ˆ$f,g:\mathbb{R}^d\rightarrow \mathbb{R}$ï¼‰ä¹‹é—´çš„å·ç§¯å®šä¹‰ä¸ºï¼š

$$
(f*g)(\mathbf{x})=\int{f(\mathbf{z})g(\mathbf{x-z})d\mathbf{z}}
$$

ä¹Ÿå°±æ˜¯è¯´ï¼Œå·ç§¯æ˜¯å½“æŠŠä¸€ä¸ªå‡½æ•°â€œç¿»è½¬â€å¹¶ç§»ä½ x æ—¶ï¼Œæµ‹é‡ f å’Œ g ä¹‹é—´çš„é‡å é¢ç§¯ã€‚ä»¥ä¸‹åŠ¨å›¾å±•ç¤ºçš„ä¸¤ä¸ªå‡½æ•°è¿›è¡Œå·ç§¯è®¡ç®—çš„è¿‡ç¨‹å±•ç¤ºï¼š

![convolution](Images/convolution.gif)

å½“ä¸ºç¦»æ•£å¯¹è±¡æ—¶ï¼Œç§¯åˆ†å°±å˜æˆæ±‚å’Œã€‚ä¾‹å¦‚ï¼šå¯¹äºç”±ç´¢å¼•ä¸º $\mathbb{Z}$ çš„ã€å¹³æ–¹å¯å’Œçš„ã€æ— é™ç»´å‘é‡é›†åˆä¸­æŠ½å–çš„å‘é‡ï¼Œæˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹å®šä¹‰ï¼š

$$
(f*g)(i)=\sum_a f(a)g(i-a)
$$

å¯¹äºäºŒç»´å¼ é‡ï¼Œåˆ™ä¸º$f$çš„ç´¢å¼•$(a,b)$å’Œ$g$çš„ç´¢å¼•$(i-a,j-b)$ä¸Šå¯¹åº”åŠ å’Œï¼š

$$
(f*g)(i,j)=\sum_{a} \sum_{b} f(a,b)g(i-a,j-b)
$$

ä¸Šå¼å½¢å¼ä¸ä¸Šæ–‡â€œå±€éƒ¨æ€§â€å¾—åˆ°çš„å…¬å¼ç±»ä¼¼ã€‚

> æ•°å­¦ä¸­ï¼Œå·ç§¯ä¸äº’ç›¸å…³ååˆ†ç±»ä¼¼ï¼ŒåŒºåˆ«å°±æ˜¯è¿ç®—æ—¶æœ‰æ²¡æœ‰â€œç¿»è½¬â€çš„æ“ä½œã€‚ä¸‹å›¾æ‰€ç¤ºå·ç§¯ä¸äº¤å‰ç›¸å…³ã€è‡ªç›¸å…³çš„åŒºåˆ«ï¼š

![Comparison_convolution_correlation](Images/Comparison_convolution_correlation.svg)

## å›¾åƒçš„é€šé“

ä¸€èˆ¬å½©è‰²å›¾ç‰‡åŒ…å«æœ‰ Rã€Gã€B ä¸‰ä¸ªé€šé“ï¼ˆChannelsï¼‰ï¼Œå®é™…ä¸Šä¸æ˜¯ä¸€ä¸ªäºŒç»´å¼ é‡ï¼Œè€Œæ˜¯ä¸€ä¸ªä¸‰ç»´å¼ é‡ï¼Œå‰ä¸¤ä¸ªè½´ä¸åƒç´ çš„ç©ºé—´ä½ç½®ï¼ˆSpatialï¼‰æœ‰å…³ï¼Œ**ç¬¬ä¸‰ä¸ªè½´å¯ä»¥çœ‹ä½œæ˜¯æ¯ä¸ªåƒç´ çš„å¤šç»´è¡¨ç¤º**ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°† $\mathbf{X}$ ç´¢å¼•ä¸º $[\mathbf{X}]_{i,j,k}$ ã€‚ç”±æ­¤å·ç§¯ç›¸åº”åœ°è°ƒæ•´ä¸º $[\mathbf{V}]_{a,b,c}$ ï¼Œè€Œä¸æ˜¯ $[\mathbf{V}]_{a,b}$ã€‚

æ­¤å¤–ï¼Œç”±äºè¾“å…¥å›¾åƒæ˜¯ä¸‰ç»´çš„ï¼Œæˆ‘ä»¬çš„éšè—è¡¨ç¤º $\mathbf{H}$ ä¹Ÿæœ€å¥½é‡‡ç”¨ä¸‰ç»´å¼ é‡ã€‚ æ¢å¥è¯è¯´ï¼Œå¯¹äºæ¯ä¸€ä¸ªç©ºé—´ä½ç½®ï¼Œæˆ‘ä»¬æƒ³è¦é‡‡ç”¨ä¸€ç»„è€Œä¸æ˜¯ä¸€ä¸ªéšè—è¡¨ç¤ºã€‚è¿™æ ·ä¸€ç»„éšè—è¡¨ç¤ºå¯ä»¥æƒ³è±¡æˆä¸€äº›äº’ç›¸å †å çš„äºŒç»´ç½‘æ ¼ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠéšè—è¡¨ç¤ºæƒ³è±¡ä¸ºä¸€ç³»åˆ—å…·æœ‰äºŒç»´å¼ é‡çš„é€šé“ï¼ˆchannelï¼‰ã€‚

![cnn_rgb](Images/cnn_rgb.gif)

è¿™äº›é€šé“æœ‰æ—¶ä¹Ÿè¢«ç§°ä¸º**ç‰¹å¾æ˜ å°„ï¼ˆfeature mapsï¼‰**ï¼Œå› ä¸ºæ¯ä¸ªé€šé“éƒ½å‘åç»­å±‚æä¾›ä¸€ç»„ç©ºé—´åŒ–çš„å­¦ä¹ ç‰¹å¾ã€‚ ç›´è§‚ä¸Šä½ å¯ä»¥æƒ³è±¡åœ¨é è¿‘è¾“å…¥çš„åº•å±‚ï¼Œä¸€äº›é€šé“ä¸“é—¨è¯†åˆ«è¾¹ç¼˜ï¼Œè€Œä¸€äº›é€šé“ä¸“é—¨è¯†åˆ«çº¹ç†ã€‚

ä¸ºäº†æ”¯æŒè¾“å…¥$\mathbf{X}$å’Œéšè—è¡¨ç¤º$\mathbf{H}$ä¸­çš„å¤šä¸ªé€šé“ï¼Œå¯ä»¥åœ¨$\mathbf{V}$ä¸­æ·»åŠ ç¬¬å››ä¸ªåæ ‡ dï¼Œå³$[V]_{a,b,c,d}$ï¼Œç»¼ä¸Šï¼š

$$
[\mathbf{H}]_{i,j,d}=\sum_{a=-\Delta}^\Delta\sum_{b=-\Delta}^\Delta \sum_c [\mathbf{V}]_{a,b,c,d}[\mathbf{X}]_{i+a,j+b,c}+u
$$

å…¶ä¸­éšè—è¡¨ç¤º $\mathbf{H}$ ä¸­çš„ç´¢å¼• $d$ è¡¨ç¤ºè¾“å‡ºé€šé“ï¼Œè€Œéšåçš„è¾“å‡ºå°†ç»§ç»­ä»¥ä¸‰ç»´å¼ é‡ $\mathbf{H}$ ä½œä¸ºè¾“å…¥è¿›å…¥ä¸‹ä¸€ä¸ªå·ç§¯å±‚ã€‚ æ‰€ä»¥ï¼Œä¸Šå¼å¯ä»¥å®šä¹‰å…·æœ‰å¤šä¸ªé€šé“çš„å·ç§¯å±‚ï¼Œè€Œå…¶ä¸­ $\mathbf{V}$ æ˜¯è¯¥å·ç§¯å±‚çš„æƒé‡ã€‚

## æ€»ç»“

å¯¹å…¨è¿æ¥å±‚ä½¿ç”¨å¹³ç§»ä¸å˜æ€§å’Œå±€éƒ¨æ€§å¾—åˆ°å·ç§¯å±‚ã€‚

åœ¨æ·±åº¦å­¦ä¹ ç ”ç©¶ç¤¾åŒºä¸­ï¼Œ $V$ è¢«ç§°ä¸ºå·ç§¯æ ¸ï¼ˆconvolution kernelï¼‰æˆ–è€…æ»¤æ³¢å™¨ï¼ˆfilterï¼‰ï¼Œå®ƒä»…ä»…æ˜¯å¯å­¦ä¹ çš„ä¸€ä¸ªå±‚çš„æƒé‡ã€‚ å½“å›¾åƒå¤„ç†çš„å±€éƒ¨åŒºåŸŸå¾ˆå°æ—¶ï¼Œå·ç§¯ç¥ç»ç½‘ç»œä¸å¤šå±‚æ„ŸçŸ¥æœºçš„è®­ç»ƒå·®å¼‚å¯èƒ½æ˜¯å·¨å¤§çš„ï¼šä»¥å‰ï¼Œå¤šå±‚æ„ŸçŸ¥æœºå¯èƒ½éœ€è¦æ•°åäº¿ä¸ªå‚æ•°æ¥è¡¨ç¤ºç½‘ç»œä¸­çš„ä¸€å±‚ï¼Œè€Œç°åœ¨å·ç§¯ç¥ç»ç½‘ç»œé€šå¸¸åªéœ€è¦å‡ ç™¾ä¸ªå‚æ•°ï¼Œè€Œä¸”ä¸éœ€è¦æ”¹å˜è¾“å…¥æˆ–éšè—è¡¨ç¤ºçš„ç»´æ•°ã€‚

å‚æ•°å¤§å¹…å‡å°‘çš„ä»£ä»·æ˜¯ï¼Œ**æˆ‘ä»¬çš„ç‰¹å¾ç°åœ¨æ˜¯å¹³ç§»ä¸å˜çš„ï¼Œå¹¶ä¸”å½“ç¡®å®šæ¯ä¸ªéšè—æ´»æ€§å€¼æ—¶ï¼Œæ¯ä¸€å±‚åªåŒ…å«å±€éƒ¨çš„ä¿¡æ¯**ã€‚ ä»¥ä¸Šæ‰€æœ‰çš„æƒé‡å­¦ä¹ éƒ½å°†ä¾èµ–äºå½’çº³åç½®ã€‚å½“è¿™ç§åç½®ä¸ç°å®ç›¸ç¬¦æ—¶ï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ°æ ·æœ¬æœ‰æ•ˆçš„æ¨¡å‹ï¼Œå¹¶ä¸”è¿™äº›æ¨¡å‹èƒ½å¾ˆå¥½åœ°æ³›åŒ–åˆ°æœªçŸ¥æ•°æ®ä¸­ã€‚ ä½†å¦‚æœè¿™åç½®ä¸ç°å®ä¸ç¬¦æ—¶ï¼Œæ¯”å¦‚å½“å›¾åƒä¸æ»¡è¶³å¹³ç§»ä¸å˜æ—¶ï¼Œæˆ‘ä»¬çš„æ¨¡å‹å¯èƒ½éš¾ä»¥æ‹Ÿåˆæˆ‘ä»¬çš„è®­ç»ƒæ•°æ®ã€‚

## å·ç§¯å±‚

![conv-full-layer](Images/conv-full-layer.gif)

### äºŒç»´å·ç§¯å±‚ï¼ˆäºŒç»´äº¤å‰ç›¸å…³ï¼‰

![correlation](https://zh.d2l.ai/_images/correlation.svg)

- è¾“å…¥$\bf X$ï¼š$n_h\times n_w$
- æ ¸ï¼ˆkernelï¼‰$\bf W$ï¼š$k_n\times k_w$
- åå·®$b\in \mathbb{R}$
- è¾“å‡º$\bf Y$ï¼š$(n_h-k_h+1)\times(n_w-k_w+1)$

$$
{\bf Y}={\bf X* \bf W}+b
$$

> $\bf W$ å’Œ $b$ æ˜¯å¯å­¦ä¹ çš„å‚æ•°ã€‚åœ¨è®¡ç®—æœºè§†è§‰å’Œæ•°å­—å›¾åƒå¤„ç†é¢†åŸŸï¼Œæœ‰è®¸å¤šäººä¸ºè®¾è®¡å¥½çš„æ ¸å‚æ•°ï¼ˆåœ¨ CNN è¿˜æœªå‡ºç°å‰ï¼Œéœ€è¦æ‰‹å·¥è®¾è®¡ï¼Œå±äºå›¾åƒç‰¹å¾å·¥ç¨‹çš„å†…å®¹ï¼‰ï¼Œæ¯”å¦‚ç”¨äºç‰¹å¾æ£€æµ‹[2]ã€æ¨¡ç³Šã€é”åŒ–çš„å„ç±»æ ¸å‚æ•°ã€‚åœ¨ Photoshop ä¸­çš„æ»¤é•œåº“ä¸­å°±é›†æˆäº†è®¸å¤šå’Œä¸åŒç”¨é€”çš„æ ¸å‚æ•°ã€‚

![DifferentKernel](Images/DifferentKernel.png)

![](Images/ConvImgEdge.png)

### äº¤å‰ç›¸å…³ vs å·ç§¯

- äºŒç»´äº¤å‰ç›¸å…³

$$y_{i,j}=\sum_{a=1}^h\sum_{b=1}^w w_{a,b}x_{i+a,j+b}$$

- äºŒç»´å·ç§¯

$$y_{i,j}=\sum_{a=1}^h\sum_{b=1}^w w_{-a,-b}x_{i+a,j+b}$$

> ç”±äºå¯¹ç§°æ€§ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­æ²¡æœ‰åŒºåˆ«ã€‚

### ä¸€ç»´å’Œä¸‰ç»´äº¤å‰ç›¸å…³

- ä¸€ç»´

$$y_i=\sum_{a=1}^hw_ax_{i+a}$$

> å¤šç”¨äºæ–‡æœ¬ã€è¯­è¨€ã€æ—¶åºåºåˆ—

- ä¸‰ç»´ï¼ˆä¸ RGB é€šé“å·ç§¯è¡¨è¾¾å¼ç±»ä¼¼ï¼‰

$$y_{i,j,k}=\sum_{a=1}^h\sum_{b=1}^w \sum_{c=1}^dw_{a,b,c}x_{i+a,j+b,k+c}$$

> å¤šç”¨äºå«æ—¶é—´ç»´åº¦çš„è§†é¢‘ã€æ°”è±¡åœ°å›¾ã€ç©ºé—´ç»´åº¦åŒ»å­¦å›¾åƒï¼ˆCTï¼‰

### æ€»ç»“

- å·ç§¯å±‚å°†è¾“å…¥å’Œæ ¸çŸ©é˜µè¿›è¡Œäº¤å‰ç›¸å…³ï¼ŒåŠ ä¸Šåç§»åå¾—åˆ°è¾“å‡º
- æ ¸çŸ©é˜µå’Œåç§»æ˜¯å¯å­¦ä¹ çš„å‚æ•°
- æ ¸çŸ©é˜µçš„å¤§å°æ˜¯è¶…å‚æ•°ï¼Œå…¶å¤§å°æ§åˆ¶å·ç§¯å±‚çš„å±€éƒ¨æ€§

### ä»£ç å®ç°

- å®ç°äº’ç›¸å…³è¿ç®—

```python
import torch
from torch import nn
from d2l import torch as d2l

def corr2d(X, K):
    h, w = K.shape
    Y = torch.zeros((X.shape[0] - h +1, X.shape[1] - w + 1))
    for i in range(Y.shape[0]):
        for j in range(Y.shape[1]):
            Y[i, j] = (X[i:i + h, j:j + w] * K).sum()
    return Y
```

- å®ç°äºŒç»´å·ç§¯å±‚

```python
class Conv2D(nn.Module):
    def __init__(self, kernel_size):
        super().__init__()
        # ä½¿ç”¨nn.Parameterä½¿å‚æ•°å¯å¯¼ï¼Œå¯ä»¥è¿›è¡Œå­¦ä¹ 
        self.weight = nn.Parameter(torch.rand(kernel_size))
        self.bias = nn.Parameter(torch.zeros(1))

    def forward(self, x):
        return corr2d(x, self.weight) + self.bias
```

- é€šè¿‡æ¢¯åº¦ä¸‹é™æ¥å­¦ä¹ æ ¸å‚æ•°

```python
#ç›´æ¥è°ƒç”¨nn.Conv2d,input channel=1,outputchannel=1
conv2d = nn.Conv2d(1, 1, kernel_size=(1, 2), bias=False)

# (channal_num, batch_num, height, width)
X = X.reshape((1, 1, 6, 8))
Y = Y.reshape((1, 1, 6, 7))
#å¢åŠ ä¸¤ä¸ªç»´åº¦ï¼Œé€šé“ç»´åº¦å’Œæ‰¹é‡å¤§å°ç»´åº¦

for i in range(10):
    Y_hat = conv2d(X)
    # è®¡ç®—æŸå¤±
    l = (Y_hat - Y)**2
    conv2d.zero_grad()
    # æ¢¯åº¦åä¼ 
    l.sum().backward()
    # æ‰‹åŠ¨ä¼˜åŒ–å‚æ•°
    conv2d.weight.data[:] -= 3e-2 * conv2d.weight.grad
    if (i + 1) % 2 == 0:
        print(f'batch {i+1}, loss {l.sum():.3f}')
```

## å‚è€ƒèµ„æ–™

[1][å·ç§¯-ç»´åŸºç™¾ç§‘](https://wiwiki.kfd.me/wiki/%E5%8D%B7%E7%A7%AF)

[2][ç‰¹å¾æ£€æµ‹-ç»´åŸºç™¾ç§‘](https://wiwiki.kfd.me/wiki/%E7%89%B9%E5%BE%81%E6%A3%80%E6%B5%8B)

---

## Q&AğŸ¤“

**Qï¼šå·ç§¯å±‚çš„æ„Ÿå—é‡ï¼ˆkernel sizeï¼‰ä¸åº”è¯¥è¶Šå¤§è¶Šå¥½å—ï¼Ÿä¸ºä»€ä¹ˆå®é™…ä¸­å¸¸è§çš„éƒ½æ˜¯3x3ã€5x5ç­‰å°å°ºå¯¸ï¼Ÿ**

**ğŸ™‹â€â™‚ï¸**ï¼šä¸ MLP ç±»ä¼¼ï¼Œå¾ˆå®½çš„éšè—å±‚ï¼ˆéå¸¸å¤šç¥ç»å…ƒï¼‰ä¸å¦‚å¤šå±‚çª„ä¸€äº›çš„éšè—å±‚å¥½è®­ç»ƒï¼Œä¸ä¹‹ç±»ä¼¼ï¼Œåœ¨ CNN ä¸­ï¼Œå°ºå¯¸å¾ˆå¤§çš„å·ç§¯å±‚ä¸å¦‚ä¸€ç»„å°ºå¯¸æ›´å°ä½†å±‚æ•°æ›´å¤šçš„å·ç§¯å±‚å¥½è®­ç»ƒã€‚ç ”ç©¶è¡¨æ˜ï¼Œç”±ç®€å•çš„ç¥ç»å…ƒæ„æˆçš„å¤šå±‚ç»“æ„ï¼Œæœ‰åŠ©äºå°†å¤æ‚ç‰¹å¾çš„æŠ½å–ä»»åŠ¡â€œ**åˆ†è€Œæ²»ä¹‹ï¼Œå±‚å±‚å‡»ç ´**â€ï¼Œå…ˆæœ‰åº•å±‚å·ç§¯æŠ½å–ä½çº§ç‰¹å¾ï¼ˆçº¹ç†ã€çº¿æ¡ç­‰ï¼‰ï¼Œå†é€šè¿‡å±‚å ç»“æ„ï¼Œè¶Šé«˜å±‚çš„å·ç§¯çš„é—´æ¥ä½œç”¨èŒƒå›´ä¼šéšç€å±‚æ•°å¢é•¿è€Œé€æ¸æ‰©å¤§ï¼Œæœ€ç»ˆè·å¾—å¤§å°ºå¯¸ä¸‹çš„ç‰¹å¾ã€‚

å…·ä½“å¯å‚è€ƒå´æ©è¾¾è¯¾ç¨‹ğŸ‘‰[ã€Šä¸ºä»€ä¹ˆä½¿ç”¨æ·±å±‚è¡¨ç¤ºã€‹]((https://www.bilibili.com/video/BV16r4y1Y7jv?p=38))
