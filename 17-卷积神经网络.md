# 17 - å·ç§¯ç¥ç»ç½‘ç»œ

---

### ğŸ¦ æœ¬èŠ‚è¯¾ç¨‹è§†é¢‘åœ°å€ ğŸ‘‡

[![Bilibil](https://i1.hdslb.com/bfs/archive/7f53ce06c826938d646dfc7dbf010a741fa8c3cc.jpg@640w_400h_100Q_1c.webp)](https://www.bilibili.com/video/BV1L64y1m7Nh)

## ä¸ºä»€ä¹ˆéœ€è¦å·ç§¯

ä¸¾ä¸ªğŸŒ°ï¼Œå¯¹äºç›®å‰ä¸»æµæ‰‹æœºæ‘„åƒå¤´æ¥è¯´ï¼Œè‡³å°‘æ‹¥æœ‰1200ä¸‡åƒç´ ï¼Œæ‹æ‘„ä¸€å¼ ç…§ç‰‡ï¼Œå¤§æ¦‚èƒ½äº§ç”Ÿ 36M åƒç´ çš„å›¾ç‰‡ï¼ˆRGBä¸‰ä¸ªé€šé“ï¼‰ï¼Œå³ä½¿åƒä¹‹å‰ç« èŠ‚ä»‹ç»çš„ä½¿ç”¨ä¸€ä¸ªæœ‰100ä¸ªç¥ç»å…ƒçš„å•éšè—å±‚ MLPï¼Œè¾“å…¥ 36M ç‰¹å¾ï¼Œ100 ä¸ªç¥ç»å…ƒå°±æœ‰ $36M\times100=3.6B=14GB$ å‚æ•°ï¼Œæ‰€ä»¥ä¸é€‚ç”¨ã€‚

æœ‰ä¸ªæ¸¸æˆâ€œWaldo åœ¨å“ªé‡Œâ€ï¼Œè¦æ±‚åœ¨ä¸€å¹…å›¾ç‰‡ä¸­æ‰¾ç‰¹å®šçš„å¯¹è±¡ã€‚å¯ä»¥å¼•ç”³å‡ºä¸¤ç‚¹ï¼š

- å¹³ç§»ä¸å˜æ€§ï¼šåˆ†ç±»å™¨ä¸å› å‡ºç°ä½ç½®æ”¹å˜è€Œæ”¹å˜è¯†åˆ«æ ‡å‡†ã€‚
- å±€éƒ¨æ€§ï¼šåªéœ€è¦åœ¨å±€éƒ¨å¯»æ‰¾å¯¹è±¡ï¼Œè€Œéè¦è¿œå¤„æ— å…³åŒºåŸŸã€‚

## ä»å…¨è¿æ¥å±‚åˆ°å·ç§¯

å°†è¾“å…¥å’Œè¾“å‡ºå˜å½¢ä¸ºçŸ©é˜µï¼ˆå®½ Ã— é«˜ï¼‰ï¼š
å°†æƒé‡å˜å½¢ä¸º 4-D å¼ é‡$(h, w)$åˆ°$(h', w')$

$$
h_{i,j}=\sum_{k,l}w_{i,j,k,l}x_{k,l}=\sum_{a,b}v_{i,j,a,b}x_{i+a,j+b}
$$

æ­¤å¤„åšæŒ‰å…ƒç´ ç›¸ä¹˜çš„å“ˆé©¬è¾¾ç§¯ã€‚

$$k=i+a,\ l=j+b$$

$v$æ˜¯$w$çš„é‡æ–°ç´¢å¼•$v_{i,j,a,b}=w_{i,j,i+a,j+b}$ï¼Œä¹Ÿå°±æ˜¯è¯´æŠŠ$\bf w$é€šè¿‡åæ ‡å˜æ¢æ˜ å°„åˆ°$\bf v$ã€‚

**å¹³ç§»ä¸å˜æ€§**

$x$çš„å¹³ç§»å¯¼è‡´$h$çš„å¹³ç§»

$v$ä¸åº”è¯¥ä¾èµ–äº$(i,j)$

è§£å†³æ–¹æ¡ˆï¼š$v_{i,j,a,b}=v_{a,b}$

$$h_{i,j}=\sum_{a,b}v_{a,b}x_{i+a,b+j}$$

è¿™å°±æ˜¯ 2 ç»´$\sout{å·ç§¯}$äº¤å‰ç›¸å…³

**å±€éƒ¨æ€§**

å½“è¯„ä¼°$h_{i,j}$æ—¶ï¼Œæˆ‘ä»¬ä¸åº”è¯¥è¿œç¦»$x_{i,j}$çš„å‚æ•°

è§£å†³æ–¹æ¡ˆï¼šå½“$|a|,|b|\gt\Delta$æ—¶ï¼Œä½¿å¾—$v_{a,b}=0$

$$h_{i,j}=\sum_{a=-\Delta}^\Delta\sum_{b=-\Delta}^\Delta v_{a,b}x_{i+a,j+b}$$

## å·ç§¯å±‚

![](\Images/conv-full-layer.gif)

### äºŒç»´å·ç§¯å±‚

è¾“å…¥$\bf X$ï¼š$n_h\times n_w$
æ ¸$\bf W$ï¼š$k_n\times k_w$
åå·®$b\in \mathbb R$
è¾“å‡º$\bf Y$ï¼š$(n_h-k_h+1)\times(n_w-k_w+1)$

$${\bf Y}={\bf X* \bf W}+b$$
$\bf W$å’Œ$b$æ˜¯å¯å­¦ä¹ çš„å‚æ•°ã€‚

**äº¤å‰ç›¸å…³ vs å·ç§¯**

äºŒç»´äº¤å‰ç›¸å…³

$$y_{i,j}=\sum_{a=1}^h\sum_{b=1}^w w_{a,b}x_{i+a,j+b}$$

äºŒç»´å·ç§¯

$$y_{i,j}=\sum_{a=1}^h\sum_{b=1}^w w_{-a,-b}x_{i+a,j+b}$$

ç”±äºå¯¹ç§°æ€§ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­æ²¡æœ‰åŒºåˆ«ã€‚

**ä¸€ç»´å’Œä¸‰ç»´äº¤å‰ç›¸å…³**

- ä¸€ç»´

$$y_i=\sum_{a=1}^hw_ax_{i+a}$$

æ–‡æœ¬ã€è¯­è¨€ã€æ—¶åºåºåˆ—

- ä¸‰ç»´

$$y_{i,j,k}=\sum_{a=1}^h\sum_{b=1}^w \sum_{c=1}^dw_{a,b,c}x_{i+a,j+b,k+c}$$

è§†é¢‘ã€åŒ»å­¦å›¾åƒã€æ°”è±¡åœ°å›¾

**æ€»ç»“**

å·ç§¯å±‚å°†è¾“å…¥å’Œæ ¸çŸ©é˜µè¿›è¡Œäº¤å‰ç›¸å…³ï¼ŒåŠ ä¸Šåç§»åå¾—åˆ°è¾“å‡º

æ ¸çŸ©é˜µå’Œåç§»æ˜¯å¯å­¦ä¹ çš„å‚æ•°

æ ¸çŸ©é˜µçš„å¤§å°æ˜¯è¶…å‚æ•°ï¼Œå°±è§„é¿äº†è¾“å…¥è¶Šå¤§æƒé‡è¶Šå¤§çš„é—®é¢˜ã€‚

### ä»£ç å®ç°

**å®ç°äº¤å‰è¿ç®—**

```
import torch
from torch import nn
from d2l import torch as d2l

def corr2d(X, K):
    h, w = K.shape
    Y = torch.zeros((X.shape[0] - h +1, X.shape[1] - w + 1))
    for i in range(Y.shape[0]):
        for j in range(Y.shape[1]):
            Y[i, j] = (X[i:i + h, j:j + w] * K).sum()
    return Y
```

**è‡ªå®šä¹‰å·ç§¯æ¨¡å—**

```
class Conv2D(nn.Module):
    def __init__(self, kernel_size):
        super().__init__()
        self.weight = nn.Parameter(torch.rand(kernel_size))
        self.bias = nn.Parameter(torch.zeros(1))

    def forward(self, x):
        return corr2d(x, self.weight) + self.bias
```

**å€ŸåŠ© PyTorch å®ç°å·ç§¯**

```
conv2d = nn.Conv2d(1, 1, kernel_size=(1, 2), bias=False)
#ç›´æ¥è°ƒç”¨Conv2d,input channel=1,outputchannel=1

X = X.reshape((1, 1, 6, 8))
Y = Y.reshape((1, 1, 6, 7))
#å¢åŠ ä¸¤ä¸ªç»´åº¦ï¼Œé€šé“ç»´åº¦å’Œæ‰¹é‡å¤§å°ç»´åº¦

for i in range(10):
    Y_hat = conv2d(X)
    l = (Y_hat - Y)**2
    conv2d.zero_grad()
    l.sum().backward()
    conv2d.weight.data[:] -= 3e-2 * conv2d.weight.grad
    #åšæ¢¯åº¦ä¼˜åŒ–
    if (i + 1) % 2 == 0:
        print(f'batch {i+1}, loss {l.sum():.3f}')
```
