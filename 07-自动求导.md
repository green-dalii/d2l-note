# 07 - è‡ªåŠ¨æ±‚å¯¼

---

### ğŸ¦ æœ¬èŠ‚è¯¾ç¨‹è§†é¢‘åœ°å€ ğŸ‘‡

[![Bilibil](https://i0.hdslb.com/bfs/archive/feadafc9bf7283f84caacc60d841a4202b0395eb.jpg@640w_400h_100Q_1c.webp)](https://www.bilibili.com/video/BV1KA411N7Px)

## 1.å‘é‡æ±‚å¯¼çš„é“¾å¼æ³•åˆ™

- æ ‡é‡é“¾å¼æ³•åˆ™

$$
y=f(u),u=g(x) \\
{{\partial{y}}\over{\partial{x}}}={{\partial{y}}\over{\partial{u}}}{{\partial{u}}\over{\partial{x}}}
$$

- å‘é‡é“¾å¼æ³•åˆ™(æ±‚å¯¼ç»“æœçš„ shape å¯ä»¥å‚è€ƒ[ç¬¬å…­è¯¾](./06-çŸ©é˜µè®¡ç®—.md))

$$
{{\partial{y}}\over{\partial{\bf{x}}}}={{\partial{y}}\over{\partial{u}}}{{\partial{u}}\over{\partial{\bf{x}}}} \\
(1,n)\ \ \ \ (1,)(1,n) \\
--- \\
{{\partial{y}}\over{\partial{\bf{x}}}}={{\partial{y}}\over{\partial{\bf{u}}}}{{\partial{\bf{u}}}\over{\partial{\bf{x}}}} \\
(1,n)\ \ \ \ (1,k)(k,n) \\
--- \\
{{\partial{\bf{y}}}\over{\partial{\bf{x}}}}={{\partial{\bf{y}}}\over{\partial{\bf{u}}}}{{\partial{\bf{u}}}\over{\partial{\bf{x}}}} \\
(m,n)\ \ \ \ (m,k)(k,n) \\
$$

- å‘é‡é“¾å¼æ³•åˆ™æ±‚å¯¼ç¤ºä¾‹ï¼š

å‡è®¾ï¼šå‘é‡ $\bf{x,w}\in\Bbb{R}^n,\ y\in\Bbb{R}$ï¼Œ$z=(\langle{\bf{x,w}}\rangle-y)^2$ï¼Œæ±‚ ${\partial{z}}\over{\partial{\bf{w}}}$ ï¼Ÿ

ä»¤ï¼š

$$
a={\langle\bf{x,w}\rangle} \\
b={a-y} \\
z=b^2
$$

åˆ™ï¼š

$$
{\partial{z}\over{\partial{\bf{w}}}}=
{{\partial{z}\over{\partial{b}}}}
{{\partial{b}\over{\partial{a}}}}
{{\partial{a}\over{\partial{\bf{w}}}}
} \\
={{\partial{b^2}\over{\partial{b}}}}
{{\partial{a-y}\over{\partial{a}}}}
{\partial{{{\langle\bf{x,w}\rangle}}}\over{\partial{\bf{w}}}} \\
={2b\cdot1\cdot\bf{x}^T} \\
=2(\langle{\bf{x,w}}\rangle-y)\bf{x}^T
$$

- çŸ©é˜µé“¾å¼æ³•åˆ™æ±‚å¯¼ç¤ºä¾‹

å‡è®¾ï¼šçŸ©é˜µ $\bf{X}\in\Bbb{R}^{m\times{n}},\ \text{å‘é‡ }\bf{w}\in{\Bbb{R^n}},\ y\in\Bbb{R^m}$ï¼Œ$z=||\bf{Xw-y}||^2$ï¼Œæ±‚ ${\partial{z}}\over{\partial{\bf{w}}}$ ï¼Ÿ

ä»¤ï¼š

$$
{\bf{a}=\bf{Xw}} \\
{\bf{b}=\bf{a-y}} \\
z=||\bf{b}||^2
$$

åˆ™ï¼š

$$
{\partial{z}\over{\partial{\bf{w}}}}=
{{\partial{z}\over{\partial{\bf{b}}}}}
{{\partial{\bf{b}}\over{\partial{\bf{a}}}}}
{{\partial{\bf{a}}\over{\partial{\bf{w}}}}
} \\
={{\partial{||\bf{b}||}^2\over{\partial{\bf{b}}}}}
{{\partial{\bf{a-y}}\over{\partial{\bf{a}}}}}
{\partial{{\bf{Xw}}}\over{\partial{\bf{w}}}}  \\
={2\bf{b}^T\cdot\bf{I}\cdot\bf{X}} \\
=2{({\bf{Xw}}-\bf{y})}^T{\bf{X}}
$$

## 2.è®¡ç®—å›¾

è®¡ç®—å›¾æ˜¯å‡ ä¹ç›®å‰æ‰€æœ‰æ·±åº¦å­¦ä¹ æ¡†æ¶ä½¿ç”¨çš„ã€ç”¨äºå®ç°ç¥ç»ç½‘ç»œè®¡ç®—çš„åº•å±‚æ¨¡å‹ï¼Œæ˜¯å°†å¤æ‚è¿ç®—æ‹†åˆ†æˆç”±å¤šä¸ªç®€å•è¿ç®—ç¬¦ï¼ˆæ“ä½œå­ï¼‰ç»„æˆçš„**æœ‰å‘æ— ç¯å›¾ï¼ˆDAG, Directed Acyclic Graph**ï¼‰ğŸ‘‰[Wiki](https://www.wanweibaike.com/wiki-%E6%9C%89%E5%90%91%E6%97%A0%E7%8E%AF%E5%9B%BE)ï¼Œå¯ä»¥å®ç°**è‡ªåŠ¨æ±‚å¯¼**ï¼ˆæ­£å‘ä¼ æ’­ã€åå‘ä¼ æ’­ BackpropagationğŸ‘‰[Wiki](https://www.wanweibaike.com/wiki-%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD%E7%AE%97%E6%B3%95)ï¼‰åŠŸèƒ½ã€‚

ä½¿ç”¨è®¡ç®—å›¾æ¨¡å‹ï¼Œå¯æ›´æ–¹ä¾¿çš„è¿›è¡Œ**å¹¶è¡ŒåŒ–è¿ç®—**ï¼ˆæƒ°æ€§æ±‚å€¼ï¼‰ï¼ŒåŒæ—¶æ‹†åˆ†æˆç®€å•çš„è¿ç®—ç¬¦ï¼Œå¯å……åˆ†åˆ©ç”¨ä¸“æœ‰ç¡¬ä»¶ï¼ˆå¦‚ GPU ç­‰ï¼‰å®ç°**ç¡¬ä»¶åŠ é€Ÿ**æ¥æå‡è®¡ç®—æ•ˆç‡ã€‚

æ­£å‘ä¼ æ’­å¤æ‚åº¦ï¼š

- è®¡ç®—å¤æ‚åº¦ä¸º**O(n)**ï¼Œn ä»£è¡¨è®¡ç®—å›¾ä¸­æ“ä½œå­æ•°ç›®
- å†…å­˜å¤æ‚åº¦ä¸º**O(1)**ï¼Œ1 è¡¨ç¤ºæ¯æ¬¡è®¡ç®—åªç”¨å­˜å‚¨å½“å‰æ“ä½œå­çš„æ•°æ®ï¼Œè®¡ç®—ä¸‹ä¸€æ“ä½œæ—¶ä¾¿å¯é‡Šæ”¾å‰ä¸€ä¸ªä¸­é—´ç»“æœï¼Œæ‰€ä»¥ä¸ºå¸¸é‡å¤æ‚åº¦

åå‘ä¼ æ’­å¤æ‚åº¦ï¼š

- è®¡ç®—å¤æ‚åº¦ä¸º**O(n)**ï¼Œä¸æ­£å‘å¤æ‚åº¦ç±»ä¼¼
- å†…å­˜å¤æ‚åº¦ä¸º**O(n)**ï¼Œå› ä¸ºè®¡ç®—åå‘æ¢¯åº¦æ—¶ï¼Œéœ€è¦æ‰€æœ‰æ“ä½œå­æ­£å‘ä¼ æ’­çš„ä¸­é—´ç»“æœ

ä»¥ä¸Šå¤æ‚åº¦ä¹Ÿå†³å®šäº†å½“ç¥ç»ç½‘ç»œéå¸¸å¤§æ—¶ï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¯¹å†…å­˜ï¼ˆCPU è®¡ç®—ï¼‰æˆ–æ˜¾å­˜ï¼ˆGPU è®¡ç®—ï¼‰å®¹é‡è¦æ±‚éå¸¸é«˜ï¼Œå› ä¸ºæ‰€æ¶ˆè€—çš„å®¹é‡æ­£æ¯”äºç¥ç»ç½‘ç»œèŠ‚ç‚¹æ•°ã€‚

å…³äºè®¡ç®—å›¾ç›¸å…³çŸ¥è¯†ï¼Œææ²æ•™ç¨‹è¾ƒä¸ºç®€ç•¥ï¼Œå¯å‚è€ƒå´æ©è¾¾(AndrewNG)çš„ DeepLearning.ai è¯¾ç¨‹ä¸­çš„ã€Šè®¡ç®—å›¾ã€‹ç« èŠ‚ ğŸ‘‰[Bilibil](https://www.bilibili.com/video/BV1FT4y1E74V?p=13)

## 3.è‡ªåŠ¨æ±‚å¯¼ä»£ç å®ç°

ç›®å‰å‡ ä¹æ‰€æœ‰çš„æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼ˆPytorchã€TensorFlowã€MXNet etc.ï¼‰å¯é€šè¿‡è‡ªåŠ¨è®¡ç®—å¯¼æ•°ï¼Œå³**è‡ªåŠ¨å¾®åˆ†**ï¼ˆautomatic differentiationï¼‰æ¥åŠ å¿«æ±‚å¯¼ã€‚

å®é™…ä¸­ï¼Œæ ¹æ®æˆ‘ä»¬è®¾è®¡çš„æ¨¡å‹ï¼Œç³»ç»Ÿä¼šæ„å»ºä¸€ä¸ªè®¡ç®—å›¾ï¼ˆcomputational graphï¼‰ï¼Œ æ¥è·Ÿè¸ªè®¡ç®—æ˜¯å“ªäº›æ•°æ®é€šè¿‡å“ªäº›æ“ä½œç»„åˆèµ·æ¥äº§ç”Ÿè¾“å‡ºã€‚ è‡ªåŠ¨å¾®åˆ†ä½¿ç³»ç»Ÿèƒ½å¤Ÿéšååå‘ä¼ æ’­æ¢¯åº¦ã€‚ è¿™é‡Œï¼Œåå‘ä¼ æ’­ï¼ˆbackpropagateï¼‰æ„å‘³ç€è·Ÿè¸ªæ•´ä¸ªè®¡ç®—å›¾ï¼Œå¡«å……å…³äºæ¯ä¸ªå‚æ•°çš„åå¯¼æ•°ã€‚

- `tensor1.requires_grad_(True)`ï¼šå‘Šè¯‰æ¡†æ¶éœ€è¦å¯¹<u>**è¯¥å¼ é‡**</u>æ±‚å¯¼
- `tensor2.backward()`ï¼šæ±‚ tensor2 å¯¹ tensor1 å¯¼æ•°ï¼ˆtensor2 éœ€ä¸º tensor1 çš„è¡¨è¾¾å¼ï¼Œä¸”æ±‚å¯¼å‰è¦æ‰§è¡Œ`requires_grad_(True)`å‘½ä»¤ï¼‰
- `tensor1.grad`ï¼šè®¿é—®æ±‚å¯¼åå¼ é‡çš„å¯¼æ•°
- `tensor.grad.zero_()`ï¼šæ¢¯åº¦æ¸…é›¶ï¼ˆPytorch é»˜è®¤ä¼šç´¯è®¡æ¢¯åº¦å¹¶å­˜å‚¨åœ¨`.grad`å†…ï¼‰
- `tensor.detach()`ï¼šå°†è¯¥å˜é‡ç§»å‡ºè®¡ç®—å›¾ï¼Œå½“ä½œå¸¸é‡å¤„ç†ï¼Œå¤šç”¨äºç¥ç»ç½‘ç»œçš„å‚æ•°å›ºå®š
- ä¸€èˆ¬å¾ˆå°‘ç”¨åˆ°å‘é‡å¯¹å‘é‡ï¼ˆä»¥åŠæ›´é«˜é˜¶ï¼‰çš„æ±‚å¯¼ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ª gradient å‚æ•°ï¼Œæ‰€ä»¥ä¼šæŠŠä¸€ä¸ªå‘é‡è½¬åŒ–ä¸ºæ ‡é‡æ±‚å¯¼ï¼Œæœ€å¸¸ç”¨çš„å°±æ˜¯æ±‚å’Œï¼š`tensor.sum().backward()`ã€‚`loss`ä¸€èˆ¬æ˜¯ä¸€ä¸ªæ ‡é‡ï¼Œå¦‚æœ loss æ˜¯çŸ©é˜µï¼Œç»´åº¦å°±ä¼šè¶Šç®—è¶Šå¤§ã€‚
- å¯ä»¥ç»è¿‡ Python è®¡ç®—æµå†æ±‚å¯¼ã€‚
